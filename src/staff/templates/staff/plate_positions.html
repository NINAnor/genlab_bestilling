{% extends "staff/base.html" %}
{% load i18n %}
{% load core %}

{% block content %}
  {% csrf_token %}
  <div x-data="platePositions()" class="max-w-full">
    <div class="flex gap-5 mb-5">
      <a class="btn btn-sm btn-tertiary" href="../">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>

    <h3 class="text-4xl mb-5">Plate {{ object }} - Positions</h3>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Plate Grid -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow overflow-x-auto p-4">
          <table class="w-full table-fixed">
            <thead>
              <tr>
                <th class="w-16"></th>
                {% for col in columns %}
                  <th class="text-center p-2 font-bold w-20">{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in grid %}
                <tr>
                  <th class="text-center p-2 font-bold">{{ rows|get_item:forloop.counter0 }}</th>
                  {% for cell in row %}
                    <td class="border p-2 text-center cursor-pointer hover:ring-2 hover:ring-blue-300 transition-all
                             {% if cell.position and not cell.position.is_full %}bg-green-100 hover:bg-green-200{% elif cell.position and cell.position.is_full %}bg-red-100 hover:bg-red-200{% else %}bg-gray-100 hover:bg-gray-200{% endif %}"
                        {% if cell.position %}
                          @click="selectPosition({{ cell.position.id }}, '{{ cell.coordinate }}')"
                          :class="{'ring-2 ring-blue-500': selectedPosition && selectedPosition.id === {{ cell.position.id }}}"
                        {% endif %}>
                      {% if cell.position %}
                        <div class="text-sm min-h-16 flex flex-col justify-center">
                          <div class="font-semibold text-xs mb-1">{{ cell.coordinate }}</div>
                          {% if cell.position.sample_raw %}
                            <span class="text-purple-600 text-xs">{{ cell.position.sample_raw.genlab_id }}</span>
                          {% elif cell.position.sample_marker %}
                            <span class="text-purple-600 text-xs">{{ cell.position.sample_marker.id }}</span>
                          {% elif cell.position.is_reserved %}
                            <span class="text-yellow-600 text-xs">Reserved</span>
                          {% else %}
                            <span class="text-gray-500 text-xs">Empty</span>
                          {% endif %}
                        </div>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Actions Panel -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-4 sticky top-4">
          <h4 class="text-lg font-semibold mb-4">Position Actions</h4>

          <div x-show="!selectedPosition" class="text-gray-500 text-center py-8">
            <i class="fas fa-mouse-pointer text-4xl mb-2"></i>
            <p>Click on a position to see available actions</p>
          </div>

          <div x-show="selectedPosition" x-transition>
            <div class="mb-4">
              <h5 class="font-medium text-gray-700">Position: <span x-text="selectedCoordinate"></span></h5>
              <p class="text-sm text-gray-500" x-text="getPositionStatus()"></p>
            </div>

            <!-- Loading state -->
            <div x-show="loading" class="text-center py-4">
              <i class="fas fa-spinner fa-spin text-blue-500"></i>
              <p class="text-sm text-gray-600 mt-2">Loading...</p>
            </div>

            <!-- Actions -->
            <div x-show="!loading && actions.length > 0" class="space-y-2">
              <template x-for="action in actions" :key="action.action">
                <button
                  @click="performAction(action.action)"
                  :class="getActionButtonClass(action.type)"
                  class="w-full px-3 py-2 rounded text-sm font-medium transition-colors"
                  x-text="action.label">
                </button>
              </template>
            </div>

            <!-- Notes editing -->
            <div x-show="showNotesEdit" x-transition class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Notes:</label>
              <textarea
                x-model="notesInput"
                class="w-full p-2 border border-gray-300 rounded text-sm"
                rows="3"
                placeholder="Enter notes..."></textarea>
              <div class="flex gap-2 mt-2">
                <button
                  @click="saveNotes()"
                  class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                  Save
                </button>
                <button
                  @click="cancelNotesEdit()"
                  class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm hover:bg-gray-400">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Messages -->
          <div x-show="message" x-transition class="mt-4 p-3 rounded text-sm"
               :class="messageType === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
            <p x-text="message"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sample Details Modal -->
    <div x-cloak x-show="showSampleDetails"

         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="closeSampleDetails()">

      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-semibold text-gray-900">
            <span x-show="sampleDetails && sampleDetails.genlab_id">Sample Details</span>
            <span x-show="sampleDetails && !sampleDetails.genlab_id">Analysis Details</span>
          </h3>
          <button @click="closeSampleDetails()"
                  class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div class="p-6">
          <!-- Loading state -->
          <div x-show="loadingSample" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
            <p class="text-gray-600 mt-2">Loading details...</p>
          </div>

          <!-- Sample Details -->
          <div x-show="!loadingSample && sampleDetails && sampleDetails.genlab_id" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Genlab ID</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.genlab_id"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sample Name</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Species</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.species?.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sample Type</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.type?.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Year</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.year"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Location</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.location?.name || 'N/A'"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Pop ID</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.pop_id || 'N/A'"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Volume</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.volume || 'N/A'"></p>
              </div>
            </div>

            <div x-show="sampleDetails.notes">
              <label class="block text-sm font-medium text-gray-700">Notes</label>
              <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.notes"></p>
            </div>
          </div>

          <!-- Analysis Details -->
          <div x-show="!loadingSample && sampleDetails && !sampleDetails.genlab_id" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Analysis ID</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.id"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sample</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.sample?.genlab_id"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Marker</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.marker?.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Order</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.order"></p>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end p-6 border-t bg-gray-50">
          <button @click="closeSampleDetails()"
                  class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function platePositions() {
      return {
        selectedPosition: null,
        selectedCoordinate: '',
        actions: [],
        loading: false,
        message: '',
        messageType: 'success',
        showNotesEdit: false,
        notesInput: '',
        showSampleDetails: false,
        sampleDetails: null,
        loadingSample: false,

        async selectPosition(positionId, coordinate) {
          if (this.selectedPosition && this.selectedPosition.id === positionId) {
            return; // Already selected
          }

          this.selectedPosition = { id: positionId };
          this.selectedCoordinate = coordinate;
          this.loading = true;
          this.actions = [];
          this.message = '';
          this.showNotesEdit = false;

          try {
            const response = await fetch(`/api/plate-positions/${positionId}/`);
            if (response.ok) {
              const data = await response.json();
              this.selectedPosition = data;
              this.actions = data.possible_actions || [];
              this.notesInput = data.notes || '';
            } else {
              console.error('Failed to load position details:', response.status, response.statusText);
              const errorData = await response.json().catch(() => ({}));
              console.error('Error response:', errorData);
              this.showMessage('Failed to load position details', 'error');
            }
          } catch (error) {
            console.error('Error loading position details:', error);
            this.showMessage('Error loading position details', 'error');
          } finally {
            this.loading = false;
          }
        },

        async performAction(actionType) {
          if (actionType === 'edit_notes') {
            this.showNotesEdit = true;
            return;
          }

          if (actionType === 'view_sample') {
            await this.viewSample();
            return;
          }

          if (actionType === 'view_analysis') {
            await this.viewAnalysis();
            return;
          }

          this.loading = true;
          this.message = '';

          try {
            const response = await fetch(`/api/plate-positions/${this.selectedPosition.id}/${actionType}/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
            });

            if (response.ok) {
              const data = await response.json();
              this.showMessage(data.message, 'success');
              // Refresh the position data
              await this.selectPosition(this.selectedPosition.id, this.selectedCoordinate);
              // Reload the page to update the grid
              setTimeout(() => window.location.reload(), 1000);
            } else {
              console.error('Action failed:', response.status, response.statusText);
              const errorData = await response.json().catch(() => ({}));
              console.error('Error response:', errorData);
              this.showMessage(errorData.error || 'Action failed', 'error');
            }
          } catch (error) {
            console.error('Error performing action:', error);
            this.showMessage('Error performing action', 'error');
          } finally {
            this.loading = false;
          }
        },

        async saveNotes() {
          this.loading = true;

          try {
            const response = await fetch(`/api/plate-positions/${this.selectedPosition.id}/edit_notes/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              },
              body: JSON.stringify({ notes: this.notesInput })
            });

            if (response.ok) {
              const data = await response.json();
              this.showMessage(data.message, 'success');
              this.showNotesEdit = false;
              this.selectedPosition.notes = this.notesInput;
            } else {
              console.error('Failed to save notes:', response.status, response.statusText);
              const errorData = await response.json().catch(() => ({}));
              console.error('Error response:', errorData);
              this.showMessage(errorData.error || 'Failed to save notes', 'error');
            }
          } catch (error) {
            console.error('Error saving notes:', error);
            this.showMessage('Error saving notes', 'error');
          } finally {
            this.loading = false;
          }
        },

        cancelNotesEdit() {
          this.showNotesEdit = false;
          this.notesInput = this.selectedPosition.notes || '';
        },

        async viewSample() {
          if (!this.selectedPosition.sample_raw) {
            this.showMessage('No sample to view', 'error');
            return;
          }

          this.loadingSample = true;
          this.sampleDetails = null;

          try {
            const response = await fetch(`/api/samples/${this.selectedPosition.sample_raw.id}/`);
            if (response.ok) {
              const data = await response.json();
              this.sampleDetails = data;
              this.showSampleDetails = true;
            } else {
              console.error('Failed to load sample details:', response.status, response.statusText);
              const errorData = await response.json().catch(() => ({}));
              console.error('Error response:', errorData);
              this.showMessage('Failed to load sample details', 'error');
            }
          } catch (error) {
            console.error('Error loading sample details:', error);
            this.showMessage('Error loading sample details', 'error');
          } finally {
            this.loadingSample = false;
          }
        },

        async viewAnalysis() {
          if (!this.selectedPosition.sample_marker) {
            this.showMessage('No analysis to view', 'error');
            return;
          }

          this.loadingSample = true;
          this.sampleDetails = null;

          try {
            const response = await fetch(`/api/sample-marker-analysis/${this.selectedPosition.sample_marker.id}/`);
            if (response.ok) {
              const data = await response.json();
              this.sampleDetails = data;
              this.showSampleDetails = true;
            } else {
              console.error('Failed to load analysis details:', response.status, response.statusText);
              const errorData = await response.json().catch(() => ({}));
              console.error('Error response:', errorData);
              this.showMessage('Failed to load analysis details', 'error');
            }
          } catch (error) {
            console.error('Error loading analysis details:', error);
            this.showMessage('Error loading analysis details', 'error');
          } finally {
            this.loadingSample = false;
          }
        },

        closeSampleDetails() {
          this.showSampleDetails = false;
          this.sampleDetails = null;
        },

        getPositionStatus() {
          if (!this.selectedPosition) return '';

          if (this.selectedPosition.sample_raw) {
            return `Contains sample: ${this.selectedPosition.sample_raw.genlab_id}`;
          } else if (this.selectedPosition.sample_marker) {
            return `Contains analysis: ${this.selectedPosition.sample_marker.id}`;
          } else if (this.selectedPosition.is_reserved) {
            return 'Reserved';
          } else {
            return 'Empty position';
          }
        },

        getActionButtonClass(type) {
          const baseClasses = 'transition-colors';
          switch (type) {
            case 'success':
              return baseClasses + ' bg-green-600 text-white hover:bg-green-700';
            case 'danger':
              return baseClasses + ' bg-red-600 text-white hover:bg-red-700';
            case 'warning':
              return baseClasses + ' bg-yellow-600 text-white hover:bg-yellow-700';
            case 'info':
              return baseClasses + ' bg-blue-600 text-white hover:bg-blue-700';
            default:
              return baseClasses + ' bg-gray-600 text-white hover:bg-gray-700';
          }
        },

        showMessage(msg, type = 'success') {
          this.message = msg;
          this.messageType = type;
          setTimeout(() => {
            this.message = '';
          }, 5000);
        }
      }
    }
  </script>
{% endblock %}
