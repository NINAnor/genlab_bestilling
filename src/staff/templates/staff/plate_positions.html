{% extends "staff/base.html" %}
{% load i18n %}
{% load core %}
{% load static %}

{% block css %}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock css %}

{% block content %}
  {% csrf_token %}
  <div x-data="platePositions()" class="max-w-full">
    <div class="flex gap-5 mb-5">
      <a class="btn btn-sm btn-tertiary" href="../">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>

    <h3 class="text-4xl mb-5">Plate {{ object }} - Positions</h3>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Plate Grid -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow overflow-x-auto p-4">
          <table class="w-full table-fixed">
            <thead>
              <tr>
                <th class="w-16"></th>
                {% for col in columns %}
                  <th class="text-center p-2 font-bold w-20">{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in grid %}
                <tr>
                  <th class="text-center p-2 font-bold">{{ rows|get_item:forloop.counter0 }}</th>
                  {% for cell in row %}
                    <td class="border p-2 text-center cursor-pointer hover:ring-2 hover:ring-blue-300 transition-all
                             {% if cell.position and cell.position.is_full %}bg-red-100 hover:bg-red-200{% elif cell.position and cell.position.is_reserved %}bg-yellow-100 hover:bg-yellow-200{% elif cell.position %}bg-green-100 hover:bg-green-200{% else %}bg-gray-100 hover:bg-gray-200{% endif %}"
                        {% if cell.position %}
                          @click="selectPosition({{ cell.position.id }}, '{{ cell.coordinate }}')"
                          :class="{'ring-2 ring-blue-500': selectedPosition && selectedPosition.id === {{ cell.position.id }}}"
                        {% endif %}>
                      {% if cell.position %}
                        <div class="text-sm min-h-16 flex flex-col justify-center">
                          <div class="font-semibold text-xs mb-1">{{ cell.coordinate }}</div>
                          {% if cell.position.sample_raw %}
                            <span class="text-purple-600 text-xs">{{ cell.position.sample_raw.genlab_id }}</span>
                          {% elif cell.position.sample_marker %}
                            <span class="text-purple-600 text-xs">{{ cell.position.sample_marker.id }}</span>
                          {% elif cell.position.is_reserved %}
                            <span class="text-yellow-600 text-xs">Reserved</span>
                          {% else %}
                            <span class="text-gray-500 text-xs">Empty</span>
                          {% endif %}
                        </div>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Actions Panel -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-4 sticky top-4">
          <h4 class="text-lg font-semibold mb-4">Position Actions</h4>

          <div x-show="!selectedPosition" class="text-gray-500 text-center py-8">
            <i class="fas fa-mouse-pointer text-4xl mb-2"></i>
            <p>Click on a position to see available actions</p>
          </div>

          <div x-show="selectedPosition" x-transition>
            <div class="mb-4">
              <h5 class="font-medium text-gray-700">Position: <span x-text="selectedCoordinate"></span></h5>
              <p class="text-sm text-gray-500" x-text="getPositionStatus()"></p>
            </div>

            <!-- Loading state -->
            <div x-show="loading" class="text-center py-4">
              <i class="fas fa-spinner fa-spin text-blue-500"></i>
              <p class="text-sm text-gray-600 mt-2">Loading...</p>
            </div>

            <!-- Actions -->
            <div x-show="!loading && actions.length > 0" class="space-y-2">
              <template x-for="action in actions" :key="action.action">
                <button
                  @click="performAction(action.action)"
                  :class="getActionButtonClass(action.type)"
                  class="w-full px-3 py-2 rounded text-sm font-medium transition-colors"
                  x-text="action.label">
                </button>
              </template>
            </div>

            <!-- Notes editing -->
            <div x-show="showNotesEdit" x-transition class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Notes:</label>
              <textarea
                x-model="notesInput"
                class="w-full p-2 border border-gray-300 rounded text-sm"
                rows="3"
                placeholder="Enter notes..."></textarea>
              <div class="flex gap-2 mt-2">
                <button
                  @click="saveNotes()"
                  class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                  Save
                </button>
                <button
                  @click="cancelNotesEdit()"
                  class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm hover:bg-gray-400">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Messages -->
          <div x-show="message" x-transition class="mt-4 p-3 rounded text-sm"
               :class="messageType === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
            <p x-text="message"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sample Details Modal -->
    <div x-cloak x-show="showSampleDetails"

         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="closeSampleDetails()">

      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-semibold text-gray-900">
            <span x-show="sampleDetails && sampleDetails.genlab_id">Sample Details</span>
            <span x-show="sampleDetails && !sampleDetails.genlab_id">Analysis Details</span>
          </h3>
          <button @click="closeSampleDetails()"
                  class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div class="p-6">
          <!-- Loading state -->
          <div x-cloak x-show="loadingSample" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
            <p class="text-gray-600 mt-2">Loading details...</p>
          </div>

          <!-- Sample Details -->
          <div x-cloak x-show="!loadingSample && sampleDetails && sampleDetails.genlab_id" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Genlab ID</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.genlab_id"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sample Name</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Species</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.species?.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sample Type</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.type?.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Year</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.year"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Location</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.location?.name || 'N/A'"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Pop ID</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.pop_id || 'N/A'"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Volume</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.volume || 'N/A'"></p>
              </div>
            </div>

            <div x-show="sampleDetails.notes">
              <label class="block text-sm font-medium text-gray-700">Notes</label>
              <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.notes"></p>
            </div>
          </div>

          <!-- Analysis Details -->
          <div x-cloak x-show="!loadingSample && sampleDetails && !sampleDetails.genlab_id" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" x-if="!sampleDetails">
              <div>
                <label class="block text-sm font-medium text-gray-700">Analysis ID</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.id"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Sample</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.sample?.genlab_id"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Marker</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.marker?.name"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Order</label>
                <p class="mt-1 text-sm text-gray-900" x-text="sampleDetails.order"></p>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end p-6 border-t bg-gray-50">
          <button @click="closeSampleDetails()"
                  class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Sample Selection Modal -->
    <div x-cloak x-show="showSampleSelection"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="closeSampleSelection()">

      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-semibold text-gray-900">Add Sample</h3>
          <button @click="closeSampleSelection()"
                  class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>

        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Select Sample for Position <span x-text="selectedCoordinate"></span>:
            </label>
            <select id="sample-select"
              data-language="en"
              data-url="{% url 'autocomplete:available-sample' %}"
              data-placeholder="Choose a sample"
              >
              <option value="">Choose a sample...</option>
            </select>
          </div>

          <div class="flex gap-3 justify-end">
            <button @click="closeSampleSelection()"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
              Cancel
            </button>
            <button @click="addSelectedSample()"
                    :disabled="!selectedSampleId"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
              Add Sample
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block body_javascript %}
  {{ block.super }}
  <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="{% static 'js/plate_positions.js' %}"></script>
{% endblock body_javascript %}
